# Skill: Malware Analysis

> Reverse engineering and analyzing malicious software, derived from Mandiant/GTIG's malware research methodology.

## When to Use

- Unknown malware found in incident
- Threat intelligence on new malware family
- Understanding attacker capabilities
- Developing detection signatures
- Attributing attacks to threat actors

## Prerequisites

- Isolated analysis environment (VM/sandbox)
- Reverse engineering tools
- Safe sample handling procedures
- Reference malware databases
- Reporting framework

## Steps

### 1. Setup Safe Environment
```
ISOLATION REQUIREMENTS:
□ Isolated VM (no network to production)
□ Snapshots for rollback
□ Host-based monitoring
□ No shared folders with host
□ Fake network services (INetSim, FakeNet)

TOOLS READY:
□ Disassembler (IDA, Ghidra, Binary Ninja)
□ Debugger (x64dbg, WinDbg, GDB)
□ PE/ELF analysis tools
□ Network monitor
□ Process monitor
□ Sandbox (Cuckoo, Any.Run)
```

### 2. Initial Triage
```
STATIC TRIAGE:
□ File type identification (file, TrID)
□ Hash calculation (MD5, SHA1, SHA256)
□ VirusTotal lookup
□ String extraction
□ Import/export analysis
□ Packer detection
□ Certificate analysis

QUICK QUESTIONS:
- What type of file is it?
- Is it packed/obfuscated?
- What capabilities does it appear to have?
- Is it known malware?
```

### 3. Static Analysis
```
BINARY ANALYSIS:
□ Disassemble in IDA/Ghidra
□ Identify main function
□ Map code structure
□ Identify interesting functions:
  - Network functions
  - File operations
  - Registry operations
  - Process manipulation
  - Crypto functions

STRING ANALYSIS:
□ Extract strings
□ Identify:
  - URLs/domains/IPs
  - File paths
  - Registry keys
  - Commands
  - Error messages
  - Configuration

IMPORT ANALYSIS:
□ Review imported functions
□ Identify capabilities:
  - Networking (WinHTTP, socket)
  - Persistence (RegSetValue)
  - Injection (WriteProcessMemory)
  - Crypto (CryptEncrypt)
```

### 4. Dynamic Analysis
```
BEHAVIORAL MONITORING:
□ Process creation
□ File system changes
□ Registry modifications
□ Network connections
□ API calls

EXECUTION:
□ Run in sandbox
□ Monitor with ProcMon
□ Capture network traffic
□ Document all behavior

TRIGGERING:
□ Provide expected input
□ Simulate C2 responses
□ Trigger different code paths
□ Test persistence after reboot
```

### 5. Code Analysis (Deep Dive)
```
FOCUS AREAS:

Anti-Analysis:
□ VM detection
□ Debugger detection
□ Sandbox detection
□ Timing checks
□ Obfuscation

C2 Protocol:
□ Communication method
□ Encryption used
□ Beacon interval
□ Command structure

Capabilities:
□ Data collection
□ Keylogging
□ Screen capture
□ File exfiltration
□ Command execution
□ Lateral movement

Persistence:
□ Mechanism used
□ Triggered how
□ Removal difficulty
```

### 6. Extract IOCs
```
NETWORK IOCs:
□ C2 domains
□ C2 IPs
□ URLs
□ User-agent strings
□ JA3/JA3S hashes

HOST IOCs:
□ File hashes
□ File paths
□ Registry keys
□ Mutex names
□ Service names
□ Scheduled task names

BEHAVIORAL IOCs:
□ Process relationships
□ Command patterns
□ Network patterns
```

### 7. Create Detections
```
YARA RULE:
□ Identify unique strings
□ Identify unique code patterns
□ Test for false positives
□ Document rule

SIGMA RULE:
□ Behavioral indicators
□ Process/command patterns
□ Log sources needed

NETWORK SIGNATURES:
□ Snort/Suricata rules
□ Domain patterns
□ Traffic patterns
```

### 8. Document & Report
```
MALWARE REPORT:
□ Executive summary
□ Technical details
□ IOCs
□ Detection rules
□ Recommendations
□ MITRE ATT&CK mapping
```

## Analysis Techniques

### Unpacking
```
PACKED MALWARE:
1. Identify packer (Detect It Easy, PEiD)
2. Options:
   a) Dump from memory after unpacking
   b) Manual unpacking (OEP finding)
   c) Automated unpacker

MEMORY DUMP:
1. Run until unpacked
2. Find original entry point
3. Dump process memory
4. Reconstruct IAT
```

### String Decryption
```
COMMON PATTERNS:
- XOR with single byte key
- XOR with multi-byte key
- RC4 encryption
- AES encryption
- Custom algorithms

APPROACH:
1. Find encrypted strings
2. Locate decryption function
3. Understand algorithm
4. Write decryptor (Python/IDAPython)
```

### C2 Protocol Analysis
```
STEPS:
1. Capture C2 traffic (or fake it)
2. Identify encryption
3. Extract keys
4. Decode protocol
5. Document commands
6. Build emulator (optional)
```

## Malware Report Template

```markdown
# Malware Analysis Report: [Malware Name]

## Executive Summary
[What is it, what does it do, who uses it]

## Sample Information
| Attribute | Value |
|-----------|-------|
| Filename | [Name] |
| SHA256 | [Hash] |
| File Type | [PE/ELF/etc.] |
| Size | [Bytes] |
| First Seen | [Date] |
| Family | [Name] |

## Technical Analysis

### Overview
[High-level description]

### Anti-Analysis
[VM/debugger evasion techniques]

### Installation/Persistence
[How it installs and persists]

### Capabilities
[What it can do]

### Command & Control
[C2 protocol details]

## MITRE ATT&CK Mapping
| Tactic | Technique | Details |
|--------|-----------|---------|
| Execution | T1059 | PowerShell execution |
| Persistence | T1547 | Registry run key |

## Indicators of Compromise

### Network
| Type | Indicator | Context |
|------|-----------|---------|
| Domain | evil.com | C2 server |

### Host
| Type | Indicator | Context |
|------|-----------|---------|
| Hash | abc123... | Main payload |
| File | C:\...\x.exe | Installation path |

## Detection Rules

### YARA
```yara
[YARA rule]
```

### Sigma
```yaml
[Sigma rule]
```

## Recommendations
[How to detect/remediate]
```

## Examples

### Good: Behavioral Analysis
```
Sample: trojan.exe (SHA256: abc123...)

Execution Behavior:
1. Creates mutex "Global\MALWARE_MTX"
2. Copies self to C:\Users\Public\svchost.exe
3. Creates registry key:
   HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Updater
4. Beacons to https://evil.com/beacon every 60 seconds
5. POST data: base64(RC4(system_info))

C2 Commands:
- 0x01: Execute command
- 0x02: Download file
- 0x03: Upload file
- 0x04: Take screenshot
```

## Anti-patterns

### ❌ Running on Production Systems
```
DON'T: Analyze malware on production network
WHY: Malware may spread, exfiltrate data
FIX: Isolated analysis environment
```

### ❌ Ignoring Anti-Analysis
```
DON'T: Run in obvious VM and wonder why it fails
WHY: Malware detects and exits
FIX: Patch anti-analysis checks
```

### ❌ Incomplete Analysis
```
DON'T: Stop at first interesting finding
WHY: Miss capabilities, IOCs
FIX: Systematic, complete analysis
```

### ❌ No Detection Output
```
DON'T: Analyze without producing detections
WHY: Analysis value not operationalized
FIX: Always produce YARA, Sigma, IOCs
```

## Metrics

- Samples analyzed
- New families identified
- Detections produced
- Time to analyze
- Coverage (capabilities identified)

## References

- Practical Malware Analysis (book)
- MITRE ATT&CK
- Mandiant malware reports
- Malware bazaar, VirusTotal
